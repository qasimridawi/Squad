<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Squad App</title>
    
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3061/3061341.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* PASTE YOUR EXISTING CSS HERE (Or just keep the file as is if you only replaced the head tags) */
        :root {
            --bg-color: #050505;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
            --accent: #7928CA;
            --accent-grad: linear-gradient(135deg, #FF0080 0%, #7928CA 100%);
            --text: #ffffff;
        }
        body { background: var(--bg-color); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 100px; }
        
        header { padding: 20px; border-bottom: 1px solid var(--card-border); position: sticky; top: 0; background: rgba(5,5,5,0.8); backdrop-filter: blur(10px); z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 24px; background: var(--accent-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #user-badge { font-size: 12px; color: #888; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 20px; }

        .card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 20px; padding: 20px; margin: 20px; position: relative; }
        .title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        
        /* Map Link Style */
        .location-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .location-text { color: #aaa; font-size: 14px; }
        .map-btn { 
            background: rgba(3, 218, 198, 0.1); 
            color: #03DAC6; 
            border: 1px solid rgba(3, 218, 198, 0.3); 
            padding: 4px 10px; 
            border-radius: 8px; 
            font-size: 11px; 
            text-decoration: none; 
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .attendees { font-size: 12px; color: #666; margin-bottom: 15px; }
        .btn-row { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 10px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .btn-join { background: white; color: black; }
        .btn-chat { background: rgba(255,255,255,0.1); color: white; }
        .btn-delete { position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 18px; cursor: pointer; opacity: 0.5; }

        .chat-area { display: none; margin-top: 15px; border-top: 1px solid var(--card-border); padding-top: 15px; }
        .messages { max-height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        
        .msg { font-size: 13px; padding: 8px; border-radius: 8px; background: rgba(255,255,255,0.05); align-self: flex-start; max-width: 80%; }
        .msg.mine { background: var(--accent); align-self: flex-end; }
        .msg.bot { background: linear-gradient(90deg, #00C6FF, #0072FF); align-self: flex-start; border: 1px solid #00C6FF; }

        .msg b { color: rgba(255,255,255,0.5); font-size: 10px; display: block; margin-bottom: 2px; }
        .chat-input-row { display: flex; gap: 5px; }
        .chat-input { flex: 1; background: black; border: 1px solid var(--card-border); color: white; padding: 8px; border-radius: 8px; }

        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { text-align: center; width: 80%; max-width: 300px; }
        .login-input { width: 100%; padding: 15px; border-radius: 12px; border: none; margin-bottom: 15px; background: #222; color: white; font-size: 16px; box-sizing: border-box;}
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--accent-grad); border-radius: 50%; border: none; color: white; font-size: 30px; box-shadow: 0 10px 30px rgba(121, 40, 202, 0.5); cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-box">
            <h1 style="margin-bottom: 30px;">Welcome to Squad</h1>
            <input type="text" id="username-input" class="login-input" placeholder="Enter your name...">
            <button class="btn btn-join" onclick="login()">Start</button>
        </div>
    </div>

    <header>
        <h1>Squad</h1>
        <div id="user-badge">Guest</div>
    </header>

    <div id="feed"></div>
    <button class="fab" onclick="createSquad()">+</button>

    <script>
        let currentUser = localStorage.getItem('squad_user');
        let openChatId = null; 

        if (currentUser) {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('user-badge').innerText = currentUser;
            loadFeed();
        }

        function login() {
            const input = document.getElementById('username-input').value;
            if (input) {
                currentUser = input;
                localStorage.setItem('squad_user', currentUser);
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('user-badge').innerText = currentUser;
                loadFeed();
            }
        }

        async function loadFeed() {
            const response = await fetch('/hangouts/');
            const data = await response.json();
            const feedDiv = document.getElementById('feed');
            
            if (document.activeElement.tagName === 'INPUT' && document.activeElement.type === 'text') return;

            feedDiv.innerHTML = ''; 

            data.feed.reverse().forEach(h => {
                const isHost = (h.host === currentUser);
                const isGoing = h.attendees.includes(currentUser);
                const isChatOpen = (h.id === openChatId); 

                let msgsHtml = '';
                h.messages.forEach(m => {
                    const isMine = m.user === currentUser;
                    const isBot = m.user === "SquadBot ü§ñ";
                    msgsHtml += `<div class="msg ${isMine ? 'mine' : ''} ${isBot ? 'bot' : ''}"><b>${m.user}</b>${m.text}</div>`;
                });

                const mapLink = `https://yandex.ru/maps/?text=${encodeURIComponent(h.location)}`;

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    ${isHost ? `<button class="btn-delete" onclick="deleteSquad(${h.id})">üóëÔ∏è</button>` : ''}
                    <div class="title">${h.title}</div>
                    
                    <div class="location-row">
                        <span class="location-text">üìç ${h.location}</span>
                        <a href="${mapLink}" target="_blank" class="map-btn">üó∫Ô∏è Open Map</a>
                    </div>

                    <div class="attendees">üë• ${h.count} Going: ${h.attendees.join(", ")}</div>
                    
                    <div class="btn-row">
                        ${!isGoing ? `<button class="btn btn-join" onclick="join(${h.id})">Join</button>` : '<button class="btn btn-join" style="opacity:0.5">Joined</button>'}
                        <button class="btn btn-chat" onclick="toggleChat(${h.id})">üí¨ Chat</button>
                    </div>

                    <div id="chat-${h.id}" class="chat-area" style="display: ${isChatOpen ? 'block' : 'none'}">
                        <div class="messages" id="msg-box-${h.id}">${msgsHtml}</div>
                        <div class="chat-input-row">
                            <input type="text" class="chat-input" id="input-${h.id}" placeholder="Type @squadbot for help...">
                            <button class="btn btn-chat" style="flex:0" onclick="send(${h.id})">‚û§</button>
                        </div>
                    </div>
                `;
                feedDiv.appendChild(card);
                
                if (isChatOpen) {
                    const msgBox = document.getElementById(`msg-box-${h.id}`);
                    msgBox.scrollTop = msgBox.scrollHeight;
                }
            });
        }

        async function createSquad() {
            const title = prompt("Plan:");
            const loc = prompt("Where (City/Place):");
            if (title) {
                await fetch('/create_hangout/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ title: title, location: loc, host_username: currentUser })
                });
                loadFeed();
            }
        }

        async function join(id) {
            await fetch('/join_hangout/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: currentUser, hangout_id: id })
            });
            loadFeed();
        }

        async function deleteSquad(id) {
            if (confirm("Delete event?")) {
                await fetch(`/delete_hangout/${id}`, { method: 'DELETE' });
                loadFeed();
            }
        }

        function toggleChat(id) {
            if (openChatId === id) {
                openChatId = null; 
            } else {
                openChatId = id; 
            }
            loadFeed(); 
        }

        async function send(id) {
            const input = document.getElementById(`input-${id}`);
            const text = input.value;
            if (text) {
                await fetch('/send_message/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: currentUser, hangout_id: id, text: text })
                });
                input.value = ''; 
                loadFeed(); 
            }
        }

        setInterval(loadFeed, 3000); 
    </script>
</body>
</html>

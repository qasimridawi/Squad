<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Squad App</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#050505">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --card: #111; --border: #333; --accent: #7928CA; --text: #fff; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 100px; }
        
        header { padding: 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: rgba(5,5,5,0.9); backdrop-filter: blur(10px); z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 24px; background: linear-gradient(135deg, #FF0080, #7928CA); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #user-badge { font-size: 12px; color: #888; background: #222; padding: 5px 10px; border-radius: 20px; }

        .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin: 20px; position: relative; overflow: hidden;}
        .title { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
        
        /* IMAGE STYLE */
        .event-img { width: 100%; height: 200px; object-fit: cover; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); display: none; }
        .event-img.show { display: block; }

        .location-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .map-btn { background: rgba(3,218,198,0.1); color: #03DAC6; padding: 4px 10px; border-radius: 8px; font-size: 11px; text-decoration: none; font-weight: bold; }

        .attendees { font-size: 12px; color: #666; margin-bottom: 15px; }
        .btn-row { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-join { background: white; color: black; }
        .btn-chat { background: #333; color: white; }
        .btn-delete { position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 18px; cursor: pointer; opacity: 0.5; }

        /* CHAT */
        .chat-area { display: none; margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px; }
        .messages { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        .msg { font-size: 13px; padding: 8px 12px; border-radius: 12px; background: #222; align-self: flex-start; max-width: 80%; }
        .msg.mine { background: var(--accent); align-self: flex-end; }
        .msg.bot { border: 1px solid #00C6FF; color: #00C6FF; background: rgba(0, 198, 255, 0.1); }
        .chat-input-row { display: flex; gap: 5px; }
        .chat-input { flex: 1; background: black; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .modal-box { width: 85%; max-width: 350px; background: #111; padding: 25px; border-radius: 20px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; }
        .modal-input { padding: 15px; background: #222; border: none; color: white; border-radius: 10px; font-size: 16px; width: 100%; box-sizing: border-box; }
        .file-label { background: #222; padding: 15px; border-radius: 10px; text-align: center; color: #888; cursor: pointer; border: 1px dashed #555; }
        
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: linear-gradient(135deg, #FF0080, #7928CA); border-radius: 50%; border: none; color: white; font-size: 30px; box-shadow: 0 10px 30px rgba(121, 40, 202, 0.5); cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-modal" class="modal" style="display: flex;">
        <div class="modal-box">
            <h2 style="text-align: center; margin: 0;">Welcome</h2>
            <input type="text" id="username-input" class="modal-input" placeholder="Your Name">
            <button class="btn btn-join" onclick="login()">Enter</button>
        </div>
    </div>

    <div id="create-modal" class="modal">
        <div class="modal-box">
            <h2 style="text-align: center; margin: 0;">New Squad</h2>
            <input type="text" id="new-title" class="modal-input" placeholder="What's the plan?">
            <input type="text" id="new-loc" class="modal-input" placeholder="Where? (City/Place)">
            
            <label class="file-label">
                üì∑ Upload Photo (Optional)
                <input type="file" id="new-img" style="display: none;" accept="image/*">
            </label>

            <div class="btn-row">
                <button class="btn btn-chat" onclick="closeCreate()">Cancel</button>
                <button class="btn btn-join" onclick="submitCreate()">Create</button>
            </div>
        </div>
    </div>

    <header>
        <h1>Squad</h1>
        <div id="user-badge">Guest</div>
    </header>

    <div id="feed"></div>
    <button class="fab" onclick="openCreate()">+</button>

    <script>
        let currentUser = localStorage.getItem('squad_user');
        let openChatId = null;

        if (currentUser) {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('user-badge').innerText = currentUser;
            loadFeed();
        }

        function login() {
            const input = document.getElementById('username-input').value;
            if (input) {
                currentUser = input;
                localStorage.setItem('squad_user', currentUser);
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('user-badge').innerText = currentUser;
                loadFeed();
            }
        }

        function openCreate() { document.getElementById('create-modal').style.display = 'flex'; }
        function closeCreate() { document.getElementById('create-modal').style.display = 'none'; }

        async function submitCreate() {
            const title = document.getElementById('new-title').value;
            const loc = document.getElementById('new-loc').value;
            const fileInput = document.getElementById('new-img');
            
            if (!title) return alert("Title required!");

            let imgData = null;
            if (fileInput.files.length > 0) {
                // Convert Image to Base64 Text
                imgData = await toBase64(fileInput.files[0]);
            }

            await fetch('/create_hangout/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    title: title, 
                    location: loc, 
                    host_username: currentUser,
                    image_data: imgData
                })
            });

            closeCreate();
            document.getElementById('new-title').value = '';
            document.getElementById('new-loc').value = '';
            fileInput.value = '';
            loadFeed();
        }

        // Helper to convert image file to text code
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        async function loadFeed() {
            if (document.activeElement.tagName === 'INPUT' && document.activeElement.type === 'text') return;
            
            const response = await fetch('/hangouts/');
            const data = await response.json();
            const feedDiv = document.getElementById('feed');
            feedDiv.innerHTML = ''; 

            data.feed.reverse().forEach(h => {
                const isHost = (h.host === currentUser);
                const isGoing = h.attendees.includes(currentUser);
                const isChatOpen = (h.id === openChatId); 

                let msgsHtml = '';
                h.messages.forEach(m => {
                    const isMine = m.user === currentUser;
                    const isBot = m.user === "SquadBot ü§ñ";
                    msgsHtml += `<div class="msg ${isMine ? 'mine' : ''} ${isBot ? 'bot' : ''}"><b>${m.user}</b>${m.text}</div>`;
                });

                const mapLink = `https://yandex.ru/maps/?text=${encodeURIComponent(h.location)}`;
                const hasImage = h.image_data ? 'show' : '';

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    ${isHost ? `<button class="btn-delete" onclick="deleteSquad(${h.id})">üóëÔ∏è</button>` : ''}
                    
                    <img src="${h.image_data || ''}" class="event-img ${hasImage}">
                    
                    <div class="title">${h.title}</div>
                    
                    <div class="location-row">
                        <span style="color:#aaa; font-size:14px">üìç ${h.location}</span>
                        <a href="${mapLink}" target="_blank" class="map-btn">üó∫Ô∏è Map</a>
                    </div>

                    <div class="attendees">üë• ${h.count} Going: ${h.attendees.join(", ")}</div>
                    
                    <div class="btn-row">
                        ${!isGoing ? `<button class="btn btn-join" onclick="join(${h.id})">Join</button>` : '<button class="btn btn-join" style="opacity:0.5">Joined</button>'}
                        <button class="btn btn-chat" onclick="toggleChat(${h.id})">üí¨ Chat</button>
                    </div>

                    <div id="chat-${h.id}" class="chat-area" style="display: ${isChatOpen ? 'block' : 'none'}">
                        <div class="messages" id="msg-box-${h.id}">${msgsHtml}</div>
                        <div class="chat-input-row">
                            <input type="text" class="chat-input" id="input-${h.id}" placeholder="Say something...">
                            <button class="btn btn-chat" style="flex:0" onclick="send(${h.id})">‚û§</button>
                        </div>
                    </div>
                `;
                feedDiv.appendChild(card);
                if (isChatOpen) {
                    const msgBox = document.getElementById(`msg-box-${h.id}`);
                    msgBox.scrollTop = msgBox.scrollHeight;
                }
            });
        }

        async function join(id) {
            await fetch('/join_hangout/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: currentUser, hangout_id: id })
            });
            loadFeed();
        }

        async function deleteSquad(id) {
            if (confirm("Delete event?")) {
                await fetch(`/delete_hangout/${id}`, { method: 'DELETE' });
                loadFeed();
            }
        }

        function toggleChat(id) {
            openChatId = (openChatId === id) ? null : id;
            loadFeed(); 
        }

        async function send(id) {
            const input = document.getElementById(`input-${id}`);
            if (input.value) {
                await fetch('/send_message/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: currentUser, hangout_id: id, text: input.value })
                });
                input.value = ''; 
                loadFeed(); 
            }
        }
        
        setInterval(loadFeed, 3000);
    </script>
</body>
</html>
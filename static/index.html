<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Squad V4.2</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#050505">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --card: #111; --border: #333; --accent: #7928CA; --text: #fff; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 100px; }
        
        /* UI COMPONENTS */
        header { padding: 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: rgba(5,5,5,0.95); z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 24px; background: linear-gradient(135deg, #FF0080, #7928CA); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        #user-badge { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #ccc; background: #222; padding: 5px 12px; border-radius: 20px; border: 1px solid #333; }
        .tiny-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; background: #444; }

        .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin: 20px; position: relative; }
        .title { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
        .event-img { width: 100%; height: 200px; object-fit: cover; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); display: none; }
        .event-img.show { display: block; }

        .location-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; color: #aaa; font-size: 14px; }
        
        .attendees { display: flex; gap: -8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .attendee-face { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--card); background: #333; object-fit: cover; margin-right: -10px; }
        .count-badge { font-size: 12px; color: #888; margin-left: 15px; align-self: center; }

        .btn-row { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-join { background: white; color: black; }
        .btn-chat { background: #333; color: white; }
        .btn-delete { position: absolute; top: 15px; right: 15px; background: rgba(255,0,0,0.2); color: #ff5555; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;}

        /* CHAT */
        .chat-area { display: none; margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px; }
        .messages { max-height: 250px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
        
        .msg-row { display: flex; gap: 8px; align-items: flex-end; }
        .msg-row.mine { flex-direction: row-reverse; }
        
        .msg-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; background: #333; flex-shrink: 0; }
        .msg-bubble { font-size: 13px; padding: 8px 12px; border-radius: 12px; background: #222; max-width: 75%; line-height: 1.4; }
        .msg-row.mine .msg-bubble { background: var(--accent); color: white; }
        .msg-row.bot .msg-bubble { border: 1px solid #00C6FF; color: #00C6FF; background: rgba(0, 198, 255, 0.1); }

        .chat-input-row { display: flex; gap: 5px; }
        .chat-input { flex: 1; background: black; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 12px; }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .modal-box { width: 85%; max-width: 350px; background: #111; padding: 25px; border-radius: 20px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; }
        .modal-input { padding: 15px; background: #222; border: none; color: white; border-radius: 10px; font-size: 16px; width: 100%; box-sizing: border-box; }
        .file-label { background: #222; padding: 15px; border-radius: 10px; text-align: center; color: #888; cursor: pointer; border: 1px dashed #555; display: block; }
        .preview-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin: 0 auto; display: none; border: 2px solid var(--accent); }
        
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: linear-gradient(135deg, #FF0080, #7928CA); border-radius: 50%; border: none; color: white; font-size: 30px; box-shadow: 0 10px 30px rgba(121, 40, 202, 0.5); cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-modal" class="modal">
        <div class="modal-box">
            <h1 style="text-align: center; margin: 0;">Squad V4</h1>
            <p style="text-align: center; color: #666; font-size: 14px;">God Mode Edition</p>
            
            <img id="reg-avatar-preview" class="preview-img">
            <label class="file-label" id="avatar-label">üì∑ Add Profile Pic (Required)
                <input type="file" id="reg-avatar" style="display: none;" accept="image/*" onchange="previewAvatar(this)">
            </label>

            <input type="text" id="login-user" class="modal-input" placeholder="Username">
            <input type="password" id="login-pass" class="modal-input" placeholder="Password">
            
            <button class="btn btn-join" onclick="login()">Login</button>
            <button class="btn btn-chat" onclick="register()">Sign Up</button>
        </div>
    </div>

    <div id="create-modal" class="modal" style="display: none;">
        <div class="modal-box">
            <h2 style="text-align: center; margin: 0;">New Squad</h2>
            <input type="text" id="new-title" class="modal-input" placeholder="Title">
            <input type="text" id="new-loc" class="modal-input" placeholder="Location">
            <label class="file-label">üì∑ Event Cover Photo
                <input type="file" id="new-img" style="display: none;" accept="image/*">
            </label>
            <div class="btn-row">
                <button class="btn btn-chat" onclick="closeCreate()">Cancel</button>
                <button class="btn btn-join" onclick="submitCreate()">Create</button>
            </div>
        </div>
    </div>

    <header>
        <h1>Squad</h1>
        <div id="user-badge" onclick="logout()">
            <img id="my-avatar" class="tiny-avatar">
            <span id="my-name">Guest</span>
        </div>
    </header>

    <div id="feed"></div>
    <button class="fab" onclick="openCreate()">+</button>

    <script>
        let token = localStorage.getItem('squad_token');
        let currentUser = localStorage.getItem('squad_user');
        let currentAvatar = localStorage.getItem('squad_avatar');
        let isAdmin = localStorage.getItem('squad_admin') === 'true';
        let sockets = {}; 

        // Initial Load
        if (!token) document.getElementById('login-modal').style.display = 'flex';
        else {
            updateBadge();
            loadFeed();
        }

        function updateBadge() {
            document.getElementById('my-name').innerText = currentUser;
            document.getElementById('my-avatar').src = currentAvatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
            if (isAdmin) document.getElementById('my-name').innerText += " (ADMIN)";
        }

        // --- BULLETPROOF IMAGE COMPRESSION ---
        // Uses URL.createObjectURL to prevent memory crashes on big files
        function resizeImage(file, maxWidth, maxHeight) {
            return new Promise((resolve, reject) => {
                if (!file) resolve(null);
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const elem = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    } else {
                        if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                    }
                    elem.width = width;
                    elem.height = height;
                    const ctx = elem.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const dataUrl = elem.toDataURL('image/jpeg', 0.7);
                    URL.revokeObjectURL(img.src); // Free memory
                    resolve(dataUrl);
                };
                img.onerror = (err) => reject("Image load error: " + err);
            });
        }

        async function previewAvatar(input) {
            try {
                const file = input.files[0];
                if (file) {
                    const resized = await resizeImage(file, 200, 200); 
                    document.getElementById('reg-avatar-preview').src = resized;
                    document.getElementById('reg-avatar-preview').style.display = 'block';
                    document.getElementById('avatar-label').innerText = "Change Photo";
                }
            } catch (e) {
                alert("Error previewing image: " + e);
            }
        }

        async function register() {
            try {
                const user = document.getElementById('login-user').value;
                const pass = document.getElementById('login-pass').value;
                const fileInput = document.getElementById('reg-avatar');
                
                if(!user || !pass) return alert("Please enter username and password.");
                
                let avatarData = null;
                if (fileInput.files.length > 0) {
                    // Force resize to tiny icon size
                    avatarData = await resizeImage(fileInput.files[0], 150, 150);
                }

                const res = await fetch('/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: user, password: pass, avatar_data: avatarData})
                });
                
                if(res.ok) { 
                    alert("Account Created! You can now Login."); 
                } else { 
                    const err = await res.json();
                    alert("Registration Failed: " + (err.detail || "Username likely taken")); 
                }
            } catch (e) {
                alert("Network/App Error: " + e);
            }
        }

        async function login() {
            try {
                const user = document.getElementById('login-user').value;
                const pass = document.getElementById('login-pass').value;
                const formData = new URLSearchParams();
                formData.append('username', user);
                formData.append('password', pass);

                const res = await fetch('/token', { method: 'POST', body: formData });
                const data = await res.json();
                
                if(res.ok) {
                    token = data.access_token;
                    currentUser = data.username;
                    currentAvatar = data.avatar;
                    isAdmin = data.is_admin;
                    
                    // Safety check for localStorage
                    try {
                        localStorage.setItem('squad_token', token);
                        localStorage.setItem('squad_user', currentUser);
                        localStorage.setItem('squad_avatar', currentAvatar || '');
                        localStorage.setItem('squad_admin', isAdmin);
                    } catch (e) {
                        alert("Warning: Phone storage full. Avatar not saved locally.");
                    }

                    document.getElementById('login-modal').style.display = 'none';
                    updateBadge();
                    loadFeed();
                } else { 
                    alert("Login Failed: Incorrect username or password."); 
                }
            } catch (e) {
                alert("Login Error: " + e);
            }
        }

        function logout() { localStorage.clear(); location.reload(); }
        function openCreate() { document.getElementById('create-modal').style.display = 'flex'; }
        function closeCreate() { document.getElementById('create-modal').style.display = 'none'; }

        async function submitCreate() {
            try {
                const title = document.getElementById('new-title').value;
                const loc = document.getElementById('new-loc').value;
                const fileInput = document.getElementById('new-img');
                let imgData = null;
                if (fileInput.files.length > 0) {
                    imgData = await resizeImage(fileInput.files[0], 800, 800);
                }

                const res = await fetch('/create_hangout/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
                    body: JSON.stringify({ title, location: loc, image_data: imgData })
                });

                if (!res.ok) throw new Error("Server rejected event.");

                closeCreate();
                loadFeed();
            } catch (e) {
                alert("Failed to create event: " + e);
            }
        }

        async function loadFeed() {
            if(!token) return;
            const response = await fetch('/hangouts/', { headers: {'Authorization': `Bearer ${token}`} });
            if(response.status === 401) logout();
            const data = await response.json();
            const feedDiv = document.getElementById('feed');
            
            const oldOpenChats = {};
            document.querySelectorAll('.chat-area').forEach(el => {
                if(el.style.display === 'block') oldOpenChats[el.id] = true;
            });

            feedDiv.innerHTML = ''; 

            data.feed.reverse().forEach(h => {
                const isHost = (h.host === currentUser);
                const isGoing = h.attendees.some(a => a.name === currentUser);
                const canDelete = isHost || isAdmin;
                const hasImage = h.image_data ? 'show' : '';
                
                let facesHtml = '';
                h.attendees.forEach(a => {
                    facesHtml += `<img src="${a.avatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="attendee-face">`;
                });

                let msgsHtml = '';
                h.messages.forEach(m => msgsHtml += renderMsg(m));

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    ${canDelete ? `<button class="btn-delete" onclick="deleteSquad(${h.id})">üóëÔ∏è</button>` : ''}
                    <img src="${h.image_data || ''}" class="event-img ${hasImage}">
                    <div class="title">${h.title}</div>
                    <div class="location-row">üìç ${h.location}</div>
                    
                    <div class="attendees">
                        ${facesHtml}
                        <div class="count-badge">${h.count} Going</div>
                    </div>

                    <div class="btn-row">
                        ${!isGoing ? `<button class="btn btn-join" onclick="join(${h.id})">Join</button>` : '<button class="btn btn-join" style="opacity:0.5">Joined</button>'}
                        <button class="btn btn-chat" onclick="toggleChat(${h.id})">üí¨ Chat</button>
                    </div>

                    <div id="chat-${h.id}" class="chat-area">
                        <div class="messages" id="msg-box-${h.id}">${msgsHtml}</div>
                        <div class="chat-input-row">
                            <input type="text" class="chat-input" id="input-${h.id}" placeholder="Message..." onkeypress="handleEnter(event, ${h.id})">
                            <button class="btn btn-chat" style="flex:0" onclick="send(${h.id})">‚û§</button>
                        </div>
                    </div>
                `;
                feedDiv.appendChild(card);
                
                if (oldOpenChats[`chat-${h.id}`]) {
                    toggleChat(h.id); 
                }
            });
        }

        function renderMsg(m) {
            const isMine = m.user === currentUser;
            const isBot = m.user.includes("Bot");
            const avatar = m.avatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
            
            return `
                <div class="msg-row ${isMine ? 'mine' : ''} ${isBot ? 'bot' : ''}">
                    ${!isMine ? `<img src="${avatar}" class="msg-avatar">` : ''}
                    <div class="msg-bubble">
                        ${!isMine ? `<b style="font-size:10px; opacity:0.7; display:block;">${m.user}</b>` : ''}
                        ${m.text}
                    </div>
                </div>`;
        }

        function toggleChat(id) {
            const chatDiv = document.getElementById(`chat-${id}`);
            const isHidden = chatDiv.style.display === 'none' || chatDiv.style.display === '';
            chatDiv.style.display = isHidden ? 'block' : 'none';
            if (isHidden) {
                connectWebSocket(id);
                const box = document.getElementById(`msg-box-${id}`);
                box.scrollTop = box.scrollHeight;
            }
        }

        function connectWebSocket(id) {
            if (sockets[id]) return;
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const wsUrl = `${protocol}://${window.location.host}/ws/${id}?token=${token}`;
            const ws = new WebSocket(wsUrl);
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                const box = document.getElementById(`msg-box-${id}`);
                box.innerHTML += renderMsg(msg);
                box.scrollTop = box.scrollHeight;
            };
            sockets[id] = ws;
        }

        function send(id) {
            const input = document.getElementById(`input-${id}`);
            if (input.value && sockets[id]) {
                sockets[id].send(input.value);
                input.value = '';
            }
        }

        function handleEnter(e, id) { if(e.key === 'Enter') send(id); }

        async function join(id) {
            await fetch(`/join_hangout/${id}`, { method: 'POST', headers: {'Authorization': `Bearer ${token}`} });
            loadFeed(); 
        }

        async function deleteSquad(id) {
            if (confirm("Delete this event?")) {
                await fetch(`/delete_hangout/${id}`, { method: 'DELETE', headers: {'Authorization': `Bearer ${token}`} });
                loadFeed();
            }
        }
    </script>
</body>
</html>

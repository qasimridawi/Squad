<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Squad V39</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#000000">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --glass-bg: rgba(255, 255, 255, 0.08); --glass-border: rgba(255, 255, 255, 0.15); --text: #ffffff; --accent: #ec4899; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: #020617;
            background-image: radial-gradient(at 10% 10%, #0f172a 0%, transparent 70%), radial-gradient(at 90% 100%, #db2777 0%, transparent 60%), radial-gradient(at 0% 100%, #7c3aed 0%, transparent 60%);
            background-attachment: fixed; background-size: cover; color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding: 0; overscroll-behavior: none; min-height: 100vh; display: flex; flex-direction: column;
        }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        header { padding: 15px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; background: rgba(0,0,0,0.2); backdrop-filter: blur(5px); }
        h1 { margin: 0; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
        #user-badge { display: flex; align-items: center; gap: 10px; padding: 6px 12px; background: rgba(255,255,255,0.1); border-radius: 99px; border: 1px solid var(--glass-border); backdrop-filter: blur(10px); cursor: pointer; }
        .tiny-avatar { width: 28px; height: 28px; border-radius: 50%; background: #333; object-fit: cover; }

        /* TOAST NOTIFICATION */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(20, 20, 20, 0.9); border: 1px solid #ec4899; padding: 12px 24px; border-radius: 99px; z-index: 4000; display: none; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideDown 0.3s forwards; }
        @keyframes slideDown { from { top: -50px; } to { top: 20px; } }

        /* STATUS DOT */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; transition: 0.3s; }
        .status-dot.green { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .status-dot.red { background: #ef4444; }

        .glowing-pin { background: #ec4899; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 15px #ec4899, 0 0 30px #ec4899; animation: pulsePin 2s infinite; }
        @keyframes pulsePin { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        .admin-badge { color: #3b82f6; display: inline-flex; margin-left: 4px; font-size: 14px; }

        #content-area { flex: 1; overflow-y: auto; padding-bottom: 140px; }
        #map-view { height: 100vh; width: 100%; display: none; position: absolute; top: 0; left: 0; z-index: 1; }
        #feed-view { display: block; padding: 20px; position: relative; z-index: 2; }
        #profile-view, #inbox-view { display: none; padding: 20px; z-index: 2; }

        .card { background: rgba(0, 0, 0, 0.3); border: 1px solid var(--glass-border); border-radius: 28px; padding: 24px; margin-bottom: 20px; backdrop-filter: blur(25px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .title { font-size: 22px; font-weight: 700; margin-bottom: 6px; line-height: 1.1; }
        .subtitle { font-size: 14px; opacity: 0.6; display: flex; align-items: center; gap: 6px; }
        .time-badge { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.1); color: #fce7f3; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; display: inline-block; margin-bottom: 12px; }
        .media-content { width: 100%; border-radius: 20px; height: 220px; object-fit: cover; display: none; margin-top: 15px; border: 1px solid var(--glass-border); }
        .media-content.show { display: block; }
        .join-btn { background: #000; color: white; border: 1px solid rgba(255,255,255,0.2); padding: 12px 28px; border-radius: 99px; font-weight: 600; font-size: 14px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        
        .inbox-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .inbox-tab { flex: 1; text-align: center; padding: 12px; border-radius: 16px; background: rgba(255,255,255,0.05); color: #888; font-weight: 600; cursor: pointer; }
        .inbox-tab.active { background: #ec4899; color: white; box-shadow: 0 5px 20px rgba(236, 72, 153, 0.4); }
        .inbox-item { display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; margin-bottom: 10px; border: 1px solid var(--glass-border); cursor: pointer; }
        .inbox-item:active { background: rgba(255,255,255,0.1); }
        .inbox-icon { width: 50px; height: 50px; border-radius: 15px; background: linear-gradient(135deg, #ec4899, #7c3aed); display: flex; justify-content: center; align-items: center; font-size: 24px; }
        .inbox-info { flex: 1; }
        .inbox-title { font-weight: 700; font-size: 16px; margin-bottom: 4px; display: flex; align-items: center; }
        .inbox-meta { font-size: 13px; opacity: 0.6; }

        .profile-header { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 20px; }
        .profile-pic-lg { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #ec4899; box-shadow: 0 0 30px rgba(236, 72, 153, 0.4); }
        .profile-name { font-size: 26px; font-weight: 800; }
        .profile-section { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; margin-bottom: 15px; }
        .section-label { font-size: 12px; color: #ec4899; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px; }
        .bio-text { font-size: 15px; line-height: 1.5; color: rgba(255,255,255,0.9); }
        .insta-btn { display: flex; align-items: center; gap: 10px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); padding: 12px 20px; border-radius: 16px; color: white; font-weight: 600; text-decoration: none; width: fit-content; margin-top: 10px; }
        .edit-input { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 12px; border-radius: 12px; color: white; width: 100%; font-family: inherit; margin-bottom: 10px; }

        .dock-container { position: fixed; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 100; pointer-events: none; }
        .glass-dock { pointer-events: auto; background: rgba(20, 20, 20, 0.65); backdrop-filter: blur(20px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 35px; padding: 10px 25px; display: flex; gap: 25px; align-items: center; box-shadow: 0 15px 40px rgba(0,0,0,0.5); }
        .dock-icon { width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 26px; cursor: pointer; transition: 0.2s; background: rgba(255,255,255,0.05); }
        .dock-icon.active { background: rgba(255,255,255,0.15); box-shadow: 0 0 15px rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .fab { position: absolute; bottom: 85px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; background: #000; border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.6); cursor: pointer; pointer-events: auto; z-index: 102; }
        .fab svg { width: 32px; height: 32px; }

        #chat-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; display: none; flex-direction: column; }
        .chat-nav { padding: 20px; display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--glass-border); }
        .chat-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; background: radial-gradient(circle at center, #0a0a0a 0%, #000000 100%); }
        .chat-bar { padding: 15px 20px; padding-bottom: 35px; background: #000; border-top: 1px solid var(--glass-border); display: flex; gap: 10px; align-items: center; }
        .input-box { flex: 1; background: rgba(255,255,255,0.1); border: none; color: white; padding: 14px 20px; border-radius: 99px; outline: none; font-size: 16px; }
        .icon-btn { width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 22px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        .icon-btn.recording { background: #ef4444; animation: pulse 1s infinite; }
        .bubble { padding: 14px 20px; border-radius: 22px; max-width: 80%; font-size: 15px; margin-bottom: 10px; }
        .bubble.them { background: rgba(255,255,255,0.1); align-self: flex-start; border-bottom-left-radius: 4px; }
        .bubble.me { background: linear-gradient(135deg, #ec4899, #8b5cf6); align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-img { max-width: 200px; border-radius: 12px; margin-top: 5px; display: block; border: 1px solid rgba(255,255,255,0.1); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-card { width: 85%; max-width: 360px; background: #0a0a0a; border: 1px solid var(--glass-border); border-radius: 36px; padding: 36px; display: flex; flex-direction: column; gap: 16px; box-shadow: 0 40px 80px rgba(0,0,0,0.9); }
        .input-field { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; padding: 18px; border-radius: 18px; width: 100%; box-sizing: border-box; font-size: 16px; outline:none; }
        .black-btn { background: #000; color: white; padding: 18px; border-radius: 99px; border: 1px solid rgba(255,255,255,0.2); font-weight: 600; width: 100%; cursor: pointer; font-size: 16px; }
        .file-label { display:block; text-align:center; padding:15px; border:1px dashed rgba(255,255,255,0.2); border-radius:16px; color:rgba(255,255,255,0.5); cursor:pointer; font-size: 14px; }
        .attendees-row { display: flex; align-items: center; margin-top: 10px; }
        .attendee-face { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #111; background: #333; object-fit: cover; margin-right: -10px; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div id="toast">
        <div style="font-size:20px;">üí¨</div>
        <div id="toast-text" style="color:white; font-size:14px; font-weight:600;">New message</div>
    </div>

    <div id="login-modal" class="modal">
        <div class="modal-card animate">
            <h2 style="text-align: center; margin: 0; font-size: 28px;">Squad</h2>
            <p style="text-align: center; opacity: 0.6; font-size: 15px;">Welcome back</p>
            <label style="cursor:pointer; text-align:center;">
                <input type="file" id="hero-avatar" style="display: none;" accept="image/*" onchange="previewAvatar(this)">
                <img id="reg-avatar-preview" style="width:90px; height:90px; border-radius:50%; object-fit:cover; display:none; margin:0 auto; border:2px solid #ec4899;">
                <div id="avatar-placeholder" style="width:90px; height:90px; border-radius:50%; background:rgba(255,255,255,0.05); margin:0 auto; display:flex; justify-content:center; align-items:center; font-size:28px;">üì∑</div>
            </label>
            <input type="text" id="login-user" class="input-field" placeholder="Username">
            <input type="password" id="login-pass" class="input-field" placeholder="Password">
            <button class="black-btn" onclick="login()">Log in</button>
            <div style="text-align: center; opacity: 0.5; font-size: 14px; margin-top: 5px; cursor: pointer;" onclick="register()">Create an account</div>
        </div>
    </div>

    <div id="create-modal" class="modal" style="display: none;">
        <div class="modal-card animate">
            <div style="display:flex; justify-content:space-between;"><h3>New Plan</h3><span onclick="document.getElementById('create-modal').style.display='none'" style="cursor:pointer; opacity:0.5;">‚úï</span></div>
            <input type="text" id="new-title" class="input-field" placeholder="What are we doing?">
            <input type="text" id="new-loc" class="input-field" placeholder="Where?">
            <div style="display:flex; gap:10px;">
                <input type="time" id="new-time" class="input-field" style="color-scheme:dark;">
                <input type="number" id="new-max" class="input-field" placeholder="Max" value="4">
            </div>
            <label class="file-label">üì∑ Cover Image <input type="file" id="new-img" style="display: none;" accept="image/*"></label>
            <button class="black-btn" onclick="submitCreate()">Post Plan</button>
        </div>
    </div>

    <div id="chat-screen">
        <div class="chat-nav">
            <button onclick="closeChat()" style="background:none;border:none;color:white;font-size:24px;">‚Üê</button>
            <div style="display:flex; flex-direction:column; justify-content:center;">
                <h3 id="chat-title" style="margin:0; font-size: 16px;">Chat</h3>
                <div style="font-size: 12px; display: flex; align-items: center; opacity: 0.7;">
                    <div id="conn-dot" class="status-dot red"></div> <span id="conn-text">Offline</span>
                </div>
            </div>
        </div>
        <div id="chat-body" class="chat-body"></div>
        <div class="chat-bar">
            <label class="icon-btn" style="display:flex; cursor:pointer;">
                üìé
                <input type="file" id="chat-img-input" style="display:none;" accept="image/*" onchange="handleImageSelect(this)">
            </label>
            
            <button class="icon-btn" id="mic-btn" onclick="toggleRecord()">üéôÔ∏è</button>
            <input id="chat-input" class="input-box" placeholder="Message..." onkeypress="if(event.key==='Enter') send()">
            <button class="icon-btn send" onclick="send()">üöÄ</button>
        </div>
    </div>

    <header><h1>Squad</h1><div id="user-badge" onclick="loadProfile(currentUser)"><span id="my-name">Guest</span><img id="my-avatar" class="tiny-avatar"></div></header>

    <div id="content-area">
        <div id="feed-view"></div>
        <div id="map-view"></div>
        <div id="profile-view"></div>
        <div id="inbox-view"></div>
    </div>

    <div class="dock-container">
        <div class="fab" onclick="document.getElementById('create-modal').style.display='flex'"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></div>
        <div class="glass-dock">
            <div class="dock-icon active" onclick="switchTab('feed')" id="nav-feed">üè†</div>
            <div class="dock-icon" onclick="switchTab('inbox')" id="nav-inbox">üí¨</div>
            <div class="dock-icon" onclick="switchTab('map')" id="nav-map">üó∫Ô∏è</div>
            <div class="dock-icon" onclick="loadProfile(currentUser)" id="nav-profile">üë§</div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('squad_token');
        let currentUser = localStorage.getItem('squad_user');
        let currentAvatar = localStorage.getItem('squad_avatar');
        let isAdmin = localStorage.getItem('squad_admin') === 'true';
        let map = null; let markers = []; let currentSocket = null; let activeDM = null;
        let personalSocket = null;
        let heartbeatInterval = null;
        let selectedChatImage = null; // Store pending image

        if (!token) document.getElementById('login-modal').style.display = 'flex'; 
        else { updateBadge(); loadFeed(); initPersonalSocket(); }

        function initPersonalSocket() {
            if (personalSocket && personalSocket.readyState === WebSocket.OPEN) return;
            const proto = location.protocol === 'https:' ? 'wss' : 'ws';
            personalSocket = new WebSocket(`${proto}://${location.host}/ws/me?token=${token}`);
            personalSocket.onopen = () => {
                updateConnectionStatus(true);
                if(heartbeatInterval) clearInterval(heartbeatInterval);
                heartbeatInterval = setInterval(() => { if(personalSocket.readyState === WebSocket.OPEN) personalSocket.send("ping"); }, 20000);
            };
            personalSocket.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                if(msg.type === "dm" && msg.sender !== currentUser) showToast(`Message from ${msg.sender}`);
                if (msg.type === "dm" && activeDM && activeDM.toLowerCase() === msg.sender.toLowerCase()) { renderMsg(msg); } 
                if (msg.type === "dm") document.getElementById('nav-inbox').style.color = '#ec4899';
            };
            personalSocket.onclose = () => { updateConnectionStatus(false); setTimeout(initPersonalSocket, 3000); };
        }

        async function handleImageSelect(input) {
            const file = input.files[0];
            if (!file) return;
            // Immediate send logic or preview? Let's send immediately for now
            const resized = await resizeImage(file, 600, 600);
            send(resized); // Pass image data to send function
            input.value = ''; // Reset
        }

        function showToast(text) {
            const t = document.getElementById('toast');
            document.getElementById('toast-text').innerText = text;
            t.style.display = 'flex';
            setTimeout(() => { t.style.display = 'none'; }, 3000);
        }

        function updateConnectionStatus(isOnline) {
            const dot = document.getElementById('conn-dot');
            const txt = document.getElementById('conn-text');
            if(dot && txt) { dot.className = `status-dot ${isOnline ? 'green' : 'red'}`; txt.innerText = isOnline ? 'Online' : 'Reconnecting...'; }
        }

        function updateBadge() { document.getElementById('my-name').innerText = currentUser; document.getElementById('my-avatar').src = currentAvatar || ''; }

        function switchTab(tab) {
            document.querySelectorAll('.dock-icon').forEach(t => t.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');
            document.querySelectorAll('#content-area > div').forEach(d => d.style.display='none');
            document.getElementById(`${tab}-view`).style.display = 'block';
            if(tab === 'map') { setTimeout(() => { if(!map) initMap(); else map.invalidateSize(); }, 100); }
            if(tab === 'inbox') { document.getElementById('nav-inbox').style.color = 'white'; loadInbox('plans'); }
        }

        async function loadInbox(type) {
            const div = document.getElementById('inbox-view');
            div.innerHTML = `<div class="inbox-tabs"><div class="inbox-tab ${type==='plans'?'active':''}" onclick="loadInbox('plans')">Plans</div><div class="inbox-tab ${type==='dms'?'active':''}" onclick="loadInbox('dms')">Messages</div></div><div id="inbox-list">Loading...</div>`;
            const list = document.getElementById('inbox-list');
            if (type === 'plans') {
                const res = await fetch('/hangouts/', { headers: {'Authorization': `Bearer ${token}`} });
                const data = await res.json();
                const myEvents = data.feed.filter(h => h.attendees.some(a => a.username === currentUser));
                list.innerHTML = myEvents.length ? '' : '<div style="opacity:0.5;text-align:center;margin-top:20px;">No plans joined.</div>';
                myEvents.forEach(h => { list.innerHTML += `<div class="inbox-item" onclick="openChat(${h.id}, '${h.title}')"><div class="inbox-icon">üéâ</div><div class="inbox-info"><div class="inbox-title">${h.title}</div><div class="inbox-meta">üìç ${h.location}</div></div></div>`; });
            } else {
                const res = await fetch('/my_dms', { headers: {'Authorization': `Bearer ${token}`} });
                const dms = await res.json();
                list.innerHTML = dms.length ? '' : '<div style="opacity:0.5;text-align:center;margin-top:20px;">No messages yet.</div>';
                dms.forEach(d => { list.innerHTML += `<div class="inbox-item" onclick="openDM('${d.partner}')"><img src="${d.avatar||''}" class="inbox-icon" style="object-fit:cover"><div class="inbox-info"><div class="inbox-title">${d.partner}</div><div class="inbox-meta">${d.last_msg}</div></div></div>`; });
            }
        }

        async function loadProfile(username) {
            switchTab('profile');
            const div = document.getElementById('profile-view');
            div.innerHTML = 'Loading...';
            const res = await fetch(`/get_user/${username}`, { headers: {'Authorization': `Bearer ${token}`} });
            const u = await res.json();
            const isMe = (username === currentUser);
            const badge = u.is_admin ? '<svg class="admin-badge" width="18" height="18" viewBox="0 0 24 24" fill="#3b82f6"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' : '';
            div.innerHTML = `<div class="profile-header animate"><img src="${u.avatar||''}" class="profile-pic-lg"><div class="profile-name" style="display:flex;align-items:center;">${u.username} ${badge}</div>${!isMe ? `<button class="join-btn" onclick="openDM('${u.username}')">üí¨ Message</button>` : ''}</div><div class="profile-section animate"><div class="section-label">About</div>${isMe ? `<textarea id="edit-bio" class="edit-input" rows="3">${u.bio}</textarea>` : `<div class="bio-text">${u.bio}</div>`}</div>${isMe ? `<div class="profile-section animate"><div class="section-label">Socials</div><input id="edit-insta" type="text" class="edit-input" value="${u.instagram}"></div><button class="black-btn" onclick="saveProfile()">Save</button><div style="text-align:center;margin-top:20px;cursor:pointer;opacity:0.6" onclick="logout()">Log Out</div>` : ''}`;
        }

        async function saveProfile() {
            await fetch('/update_profile', { method: 'POST', headers: {'Content-Type':'application/json', 'Authorization': `Bearer ${token}`}, body: JSON.stringify({bio: document.getElementById('edit-bio').value, instagram: document.getElementById('edit-insta').value}) });
            alert("Saved!");
        }

        function initMap() { map = L.map('map-view').setView([55.7558, 37.6173], 10); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map); loadMapMarkers(); }
        async function loadMapMarkers() {
            if(!token) return;
            const res = await fetch('/hangouts/', { headers: {'Authorization': `Bearer ${token}`} });
            const data = await res.json();
            markers.forEach(m => map.removeLayer(m)); markers = [];
            data.feed.forEach(h => { 
                const icon = L.divIcon({ className: 'custom-div-icon', html: "<div class='glowing-pin'></div>", iconSize: [20, 20], iconAnchor: [10, 10] });
                markers.push(L.marker([55.7558 + (Math.random()-0.5)*0.1, 37.6173 + (Math.random()-0.5)*0.1], {icon: icon}).addTo(map).bindPopup(`<b>${h.title}</b><br>‚è∞ ${h.event_time}`)); 
            });
        }
        
        async function loadFeed() {
            const res = await fetch('/hangouts/', { headers: {'Authorization': `Bearer ${token}`} });
            const data = await res.json();
            const div = document.getElementById('feed-view');
            div.innerHTML = '';
            data.feed.reverse().forEach((h, index) => {
                let faces = ''; h.attendees.forEach(a => { faces += `<img src="${a.avatar||''}" class="attendee-face" onclick="loadProfile('${a.username}')">`; });
                const card = document.createElement('div'); card.className = 'card animate'; card.style.animationDelay = `${index * 0.1}s`;
                card.innerHTML = `<div class="card-header"><div><div class="time-badge">Today, ${h.event_time}</div><div class="title">${h.title}</div><div class="subtitle">üìç ${h.location}</div></div></div>${h.image_data ? `<img src="${h.image_data}" class="media-content show">` : ''}<div style="display:flex;justify-content:space-between;margin-top:15px;"><div><div class="attendees-row">${faces}</div></div><button class="join-btn" onclick="openChat(${h.id}, '${h.title}')">Join</button></div>`;
                div.appendChild(card);
            });
        }

        async function openChat(id, title) {
            activeDM = null;
            setupChatUI(title);
            const res = await fetch(`/chat_history/${id}`, { headers: {'Authorization': `Bearer ${token}`} });
            const msgs = await res.json();
            msgs.forEach(m => renderMsg(m));
            if(currentSocket) currentSocket.close();
            const proto = location.protocol === 'https:' ? 'wss' : 'ws';
            currentSocket = new WebSocket(`${proto}://${location.host}/ws/${id}?token=${token}`);
            currentSocket.onmessage = e => { renderMsg(JSON.parse(e.data)); };
        }

        async function openDM(partner) {
            if (!personalSocket || personalSocket.readyState !== WebSocket.OPEN) initPersonalSocket();
            activeDM = partner;
            setupChatUI(partner);
            const res = await fetch(`/dm_history/${partner}`, { headers: {'Authorization': `Bearer ${token}`} });
            const msgs = await res.json();
            msgs.forEach(m => renderMsg(m)); 
        }

        function setupChatUI(title) {
            document.getElementById('chat-screen').style.display = 'flex'; document.getElementById('chat-title').innerText = title; document.getElementById('chat-body').innerHTML = ''; document.querySelector('.dock-container').style.display = 'none';
            updateConnectionStatus(personalSocket && personalSocket.readyState === WebSocket.OPEN);
        }

        function renderMsg(m) {
            const isMe = m.user === currentUser;
            const badge = m.is_admin ? 'üîπ' : '';
            // RENDER TEXT OR IMAGE
            let content = '';
            if (m.image) content += `<img src="${m.image}" class="chat-img">`;
            if (m.text) content += `<div>${m.text}</div>`;
            if (m.text && m.text.startsWith('data:audio')) content = `<audio controls src="${m.text}"></audio>`;

            const html = `<div class="bubble ${isMe ? 'me' : 'them'}">${!isMe ? `<div style="font-size:10px;opacity:0.6">${m.user} ${badge}</div>` : ''}${content}</div>`;
            document.getElementById('chat-body').insertAdjacentHTML('beforeend', html);
            document.getElementById('chat-body').scrollTop = document.getElementById('chat-body').scrollHeight;
        }

        async function send(imageData = null) {
            const input = document.getElementById('chat-input');
            const txt = input.value;
            
            if(!txt && !imageData) return;
            
            const payload = { text: txt, image: imageData }; // Construct payload

            if (activeDM) {
                // Private DM
                await fetch('/send_dm', { 
                    method: 'POST', 
                    headers: {'Content-Type':'application/json', 'Authorization': `Bearer ${token}`}, 
                    body: JSON.stringify({receiver: activeDM, ...payload}) 
                });
                renderMsg({user: currentUser, ...payload});
            } else {
                // Group Chat
                if(currentSocket) currentSocket.send(JSON.stringify(payload));
            }
            input.value = '';
        }

        function closeChat() { document.getElementById('chat-screen').style.display = 'none'; document.querySelector('.dock-container').style.display = 'flex'; if(currentSocket) currentSocket.close(); activeDM = null; }
        function resizeImage(file, w, h) { return new Promise((resolve) => { if(!file) resolve(null); const img = new Image(); img.src = URL.createObjectURL(file); img.onload = () => { const cvs = document.createElement('canvas'); let scale = Math.max(w/img.width, h/img.height); cvs.width = w; cvs.height = h; cvs.getContext('2d').drawImage(img, 0,0, img.width*scale, img.height*scale); resolve(cvs.toDataURL('image/jpeg', 0.7)); }; }); }
        async function previewAvatar(i) { selectedFileGlobal = i.files[0]; const r = await resizeImage(selectedFileGlobal, 200, 200); document.getElementById('reg-avatar-preview').src = r; document.getElementById('reg-avatar-preview').style.display = 'block'; document.getElementById('avatar-placeholder').style.display='none'; }
        async function register() { let u = document.getElementById('login-user').value; let p = document.getElementById('login-pass').value; let av = selectedFileGlobal ? await resizeImage(selectedFileGlobal, 150, 150) : null; const res = await fetch('/register', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username:u, password:p, avatar_data:av}) }); if(res.ok) alert("Registered!"); else alert("Taken"); }
        async function login() { let u = document.getElementById('login-user').value; let p = document.getElementById('login-pass').value; const res = await fetch('/token', { method: 'POST', body: new URLSearchParams({username:u, password:p}) }); const d = await res.json(); if(res.ok) { token = d.access_token; currentUser = d.username; currentAvatar = d.avatar; isAdmin = d.is_admin; localStorage.setItem('squad_token', token); localStorage.setItem('squad_user', currentUser); localStorage.setItem('squad_avatar', currentAvatar||''); localStorage.setItem('squad_admin', isAdmin); document.getElementById('login-modal').style.display='none'; updateBadge(); loadFeed(); initPersonalSocket(); } else alert("Fail"); }
        async function submitCreate() { let t = document.getElementById('new-title').value; let l = document.getElementById('new-loc').value; let tm = document.getElementById('new-time').value || "Now"; let mx = document.getElementById('new-max').value || 4; let f = document.getElementById('new-img').files[0]; let img = f ? await resizeImage(f, 800, 800) : null; if(!t) return alert("Title needed"); await fetch('/create_hangout/', { method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`}, body:JSON.stringify({title:t, location:l, event_time:tm, max_people:parseInt(mx), image_data:img}) }); document.getElementById('create-modal').style.display='none'; loadFeed(); }
        function logout() { localStorage.clear(); location.reload(); }
        let mediaRecorder; let audioChunks = []; let isRecording = false; const micBtn = document.getElementById('mic-btn');
        async function toggleRecord() { if (!isRecording) { try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); mediaRecorder = new MediaRecorder(stream); mediaRecorder.start(); audioChunks = []; mediaRecorder.ondataavailable = e => audioChunks.push(e.data); isRecording = true; micBtn.classList.add('recording'); } catch(e) { alert("Mic denied."); } } else { if(mediaRecorder) { mediaRecorder.stop(); mediaRecorder.onstop = () => { const blob = new Blob(audioChunks, { type: 'audio/webm' }); const reader = new FileReader(); reader.readAsDataURL(blob); reader.onloadend = () => { if(currentSocket) currentSocket.send(JSON.stringify({text: reader.result})); } }; } isRecording = false; micBtn.classList.remove('recording'); } }
        let selectedFileGlobal = null;
    </script>
</body>
</html>
